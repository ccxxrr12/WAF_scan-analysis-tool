**科目20：WAF规则智能识别与分析工具设计**

### 科目核心目标拆解

该科目要求开发一个三合一的专业工具，本项目将其分解为：
1.  **识别目标网站使用了哪种WAF**（指纹识别）。
2.  **解析并理解该WAF的规则集**（规则分析）。
3.  **智能地判断一个请求是否会被WAF拦截**（智能检测）。



---

### 第一部分：WAF指纹识别引擎开发

**目标**：被动或主动地探测一个Web应用，判断其背后是否有WAF，并识别出具体的WAF产品（如Cloudflare, AWS WAF, ModSecurity等）。

#### 初步思路

1.  **被动检测**
    *   **原理**：许多WAF会在HTTP响应头、Cookie或错误页面中留下独特的“指纹”。
    *   **实现**：
        *   **指纹库构建**：收集主流WAF的独特标识。例如：
            *   **Cloudflare**： `__cfduid` Cookie， `cf-ray` 响应头， `server: cloudflare` 头。
            *   **AWS WAF**： `x-amz-id-2`, `x-amz-request-id` 头（当与AWS服务集成时）。
            *   **Imperva (Incapsula)**： `visid_incap_` Cookie， `X-CDN: Incapsula` 头。
            *   **ModSecurity**： 可能返回 `406 Not Acceptable` 状态码，或在响应体中包含特定字符串。
        *   **检测引擎**：发送一个正常的HTTP请求（如GET /），然后检查响应头/体是否与指纹库中的条目匹配。这可以用简单的字符串匹配或正则表达式实现。

2.  **主动探测**
    *   **原理**：故意发送一些看似恶意或异常的HTTP请求，观察WAF的响应与正常Web服务器的差异。
    *   **实现**：
        *   **恶意载荷库**：构建一个包含常见攻击片段的载荷库，如 `' OR 1=1--` (SQLi), `<script>alert(1)</script>` (XSS)。
        *   **差异分析**：
            *   向目标发送一个正常请求，记录响应（状态码、响应体长度等）。
            *   发送一个恶意载荷，再次记录响应。
            *   **WAF存在指标**：
                *   **状态码差异**：正常请求返回200，恶意请求返回403/406/501等。
                *   **响应体差异**：出现特定的WAF拦截页面（如Cloudflare的挑战页面）。
                *   **响应时间差异**：WAF的检测逻辑可能导致请求处理变慢。
        *   **指纹精细识别**：不同的WAF对同一攻击的拦截页面和响应头不同，通过分析这些差异可以精确定位WAF类型。

#### 相关库与资源

*   **核心参考项目**:
    *   **https://github.com/EnableSecurity/wafw00f  **业界标准**的WAF指纹识别工具。其源码是学习被动和主动探测方法的**  
    *   **https://github.com/projectdiscovery/nuclei** 

*   **辅助库**:
    *   **Python HTTP库**： https://github.com/psf/requests 或性能更好的 https://github.com/encode/httpx，用于发送HTTP请求。


---

### 第二部分：规则解析与语法分析

**目标**：实现对ModSecurity等WAF规则文件的解析，理解其语法结构，并能进行高级分析（如依赖、冲突检测）和可视化。

#### 初步思路

1.  **语法解析器开发**
    *   **原理**：这是一个典型的编译原理问题。我们需要为ModSecurity规则语言定义一套**语法规则**。
    *   **实现路径**：
        *   **路径A（快速实现）**：使用**正则表达式**。ModSecurity规则（如 `SecRule ARGS "@rx <script>" "id:1,block"`）有相对固定的模式，可以用正则提取出指令、变量、操作符和动作。
        *   **路径B（标准方法）**：使用**解析器生成器**。
            *   定义词法规则（识别关键字如 `SecRule`、字符串、逗号等）。
            *   定义语法规则（BNF范式），描述一条规则由哪些部分按什么顺序构成。
            *   使用工具如 **https://www.antlr.org/** 或 Python的 **https://github.com/dabeaz/ply** 生成解析器，用以生成一个可以遍历的**抽象语法树**。

2.  **语义分析与高级功能**
    *   **依赖关系检测**：规则可以通过 `chain` 动作链接。解析器需要能识别出这些链式规则，并将其视为一个逻辑整体。
    *   **冲突检查**：检查是否有两条规则ID相同，或是否存在逻辑上可能矛盾的规则。
    *   **可视化（AST）**：将解析后的规则结构用树形图展示。可以使用 **https://graphviz.org/** 的Python接口（https://github.com/pydot/pydot）来生成规则逻辑的流程图。

#### 相关库与资源

*   **核心参考项目**:
    *   https://github.com/coreruleset/coreruleset ModSecurity的官方规则集。(**测试数据源**)
    *   https://github.com/SpiderLabs/ModSecurity  官方引擎源码

*   **解析器开发工具**:
    *   https://github.com/dabeaz/ply Python Lex-Yacc，纯Python实现的解析器生成工具
    *   https://github.com/antlr/antlr4 功能更强大的解析器生成器，支持多种目标语言

*   **可视化工具**:
    *   https://github.com/pydot/pydot Graphviz的Python接口，用于创建图形。
    *   https://github.com/matplotlib/matplotlib 绘图库

---

### 第三部分：智能检测与机器学习集成

**目标**：收集WAF的拦截样本，训练一个AI模型，使其能够直接判断一个HTTP请求是否“看起来”会被WAF拦截。

#### 初步思路

1.  **数据集构建**
    *   **数据收集**：使用模块一（WAF探测引擎）和模块二（规则解析器）。
        *   **方法一（基于规则）**：解析CRS规则，自动生成大量能触发每条规则的恶意请求和正常的请求。
        *   **方法二（基于流量）**：对一个受WAF保护的网站进行扫描和攻击，捕获所有请求和响应，人工或基于状态码标记哪些被拦截。
    *   **数据标注**：每个HTTP请求样本都需要一个标签，例如 `0`（放行）或 `1`（拦截），或者更细粒度的标签（如SQLi拦截、XSS拦截）。
    *   **特征工程**：如下预处理内容
        *   **URL和参数特征**：URL长度、参数个数、参数值的长度、是否包含特殊字符（如 `'`, `<`, `&`）等。
        *   **请求头特征**：User-Agent是否非常见、Content-Type是否异常、头部的数量等。
        *   **Payload文本特征**：将整个请求体或参数值视为文本，使用NLP技术提取特征（如词袋模型、n-gram）。或者直接使用预训练模型进行词嵌入。

2.  **模型选择与训练**
    *   **基线模型**：先从简单的模型开始，如逻辑回归、随机森林，以评估特征的有效性。
    *   **深度学习模型**：
        *   **文本分类模型**：将HTTP请求视为一段文本，使用CNN或RNN（LSTM）进行分类。
        *   **结构化数据模型**：若用手工提取特征，可以使用全连接神经网络或梯度提升树（如XGBoost）。
    *   **训练**：将数据集分为训练集、验证集和测试集，使用验证集调整超参数，最终在测试集上评估准确率、召回率等性能指标。

#### 相关库与资源

*   **机器学习框架**:
    *   https://github.com/scikit-learn/scikit-learn 传统机器学习模型
    *   https://github.com/xgboost/xgboost 梯度提升库。
    *   https://github.com/pytorch/pytorch 或 https://github.com/tensorflow/tensorflow 深度学习框架。

*   **NLP与文本处理**:
    *   https://github.com/keras-team/keras 深度学习的高级API，可以快速搭建CNN/LSTM文本分类模型。
    *   https://github.com/explosion/spaCy 工业级NLP库，用于文本处理。



### 总结与项目架构

作为一个较庞大的项目，本组采用**模块化开发**，三个部分相对独立地进行。

1.  **模块&&分工**：
    *   **模块一**：实现指纹识别引擎，打造工具的第一个可用功能。
        * 陈学睿 
    *   **第二阶段**：攻克规则解析器（使用PLY），实现规则可视化。
        * 贺俊杰 许嘉俊 王陶阳 李钰凯
    *   **第三阶段**：收集数据，训练和集成机器学习模型。
        * 陈学睿
2.  **最终形态**：一个命令行程序或Web界面工具，用户输入一个URL，工具能自动识别WAF、解析其规则（如果可能）、并利用AI模型预测攻击载荷的绕过概率。