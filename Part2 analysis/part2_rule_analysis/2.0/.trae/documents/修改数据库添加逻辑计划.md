# 修改数据库添加逻辑计划

## 问题分析
当前数据库添加逻辑存在以下问题：
1. 对于相同ID的规则，仅检查存在性，不进行内容比较和更新
2. 对于id:unknown的规则，每次生成唯一UUID，导致重复插入
3. 运行多次后数据库规则数超过规则集实际数量

## 解决方案

### 1. 提取核心规则比较逻辑
- 在`database.py`中实现`get_core_rule_content`方法，用于提取规则的核心内容进行比较
- 核心字段包括：variables、operator、pattern、is_chain（与compare_rules.py保持一致）

### 2. 修改batch_insert方法
- 对于有明确ID的规则：
  - 检查规则是否已存在
  - 如果存在，比较核心内容是否变化
  - 如果变化，执行更新操作，记录更新时间
  - 如果不变，跳过
- 对于id:unknown的规则：
  - 提取核心规则内容
  - 在数据库中搜索匹配的核心内容
  - 如果找到匹配，使用现有规则ID
  - 如果未找到，生成唯一UUID

### 3. 修改insert方法
- 与batch_insert保持一致的逻辑
- 支持单个规则的更新和相似规则查找

### 4. 优化规则匹配算法
- 使用结构化字段进行快速匹配
- 对于列表类型字段进行排序后比较
- 确保比较结果的准确性

## 修改文件
- `database.py`：修改batch_insert和insert方法，添加get_core_rule_content方法

## 预期效果
1. 相同ID的规则会根据内容自动更新
2. id:unknown的规则会找到相似规则并复用ID
3. 多次运行后数据库规则数量与规则集实际数量一致
4. 规则更新时有时间记录，便于追踪
5. 提高数据库存储空间利用率