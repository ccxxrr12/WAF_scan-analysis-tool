# WAF扫描分析工具使用说明

## 0.首先根据各模块文档安装对应依赖

## 1. 工具概述

WAF扫描分析工具是一个集WAF指纹识别、规则分析和智能检测于一体的综合性Web应用防火墙(WAF)分析系统。本使用文档将详细介绍如何安装、配置和使用该工具，帮助用户快速上手。

## 2. 安装与配置

### 2.1 环境要求
- **操作系统**：Windows/Linux/macOS
- **Python版本**：3.7或更高版本
- **Node.js版本**：16.0或更高版本
- **包管理器**：npm或pnpm（推荐）

### 2.2 安装步骤

#### 2.2.1 克隆项目
```bash
git clone https://github.com/your-username/WAF_scan-analysis-tool.git
cd WAF_scan-analysis-tool
```

#### 2.2.2 安装后端依赖
```bash
cd backend
pip install -r requirements.txt
```

#### 2.2.3 安装前端依赖
```bash
cd ../UI_3.0/ruoyi-element-ai
pnpm install
```

### 2.3 启动服务

#### 2.3.1 启动后端服务
```bash
cd ../../backend
python main.py
```
服务将在 http://0.0.0.0:8000 启动，您可以通过 http://localhost:8000/docs 访问API文档。

#### 2.3.2 启动前端服务
```bash
cd ../UI_3.0/ruoyi-element-ai
pnpm run dev
```
前端将在 http://localhost:5173 启动，您可以在浏览器中访问该地址使用工具。

### 2.4 配置说明

#### 2.4.1 后端配置
后端配置主要通过环境变量进行管理，您可以在启动服务前设置以下环境变量：

| 环境变量 | 描述 | 默认值 |
|---------|------|--------|
| PORT | 后端服务监听的端口 | 8000 |
| CORS_ORIGINS | 允许的跨域来源 | *（生产环境应限制具体域名） |

#### 2.4.2 前端配置
前端配置主要在`.env.development`（开发环境）和`.env.production`（生产环境）文件中进行管理：

| 配置项 | 描述 | 默认值 |
|-------|------|--------|
| VITE_API_BASE_URL | 后端API的基础URL | http://localhost:8000 |
| VITE_APP_TITLE | 应用标题 | WAF扫描分析工具 |

## 3. 使用指南

### 3.1 WAF扫描功能

WAF扫描功能用于识别目标网站使用的WAF类型，操作步骤如下：

1. **打开WAF扫描页面**
   在前端界面左侧导航栏中，点击"WAF扫描"菜单项，进入WAF扫描页面。

2. **输入目标URL**
   在URL输入框中输入您要扫描的目标网站URL，例如：`https://www.example.com`。

3. **执行扫描**
   点击"开始扫描"按钮，系统将开始对目标网站进行WAF指纹识别。

4. **查看扫描结果**
   扫描完成后，页面将显示扫描结果，包括：
   - 检测到的WAF类型
   - WAF厂商信息
   - 检测方法
   - 扫描耗时

5. **导出扫描报告**
   点击"导出报告"按钮，可以将扫描结果导出为JSON或CSV格式。

### 3.2 规则分析功能

规则分析功能用于ModSecurity规则的自动化分析，操作步骤如下：

1. **打开规则分析页面**
   在前端界面左侧导航栏中，点击"规则分析"菜单项，进入规则分析页面。

2. **上传规则文件**
   点击"上传文件"按钮，选择要分析的ModSecurity规则文件。支持的文件格式包括：
   - .conf
   - .txt
   - .rules

3. **执行分析**
   点击"开始分析"按钮，系统将开始对规则文件进行分析。

4. **查看分析结果**
   分析完成后，页面将显示以下结果：
   - 规则总数
   - 规则基本信息（ID、阶段、变量、操作符等）
   - 语义分析结果（攻击类型、保护层级等）
   - 依赖分析结果（规则执行顺序、依赖关系等）
   - 冲突分析结果（规则冲突、冗余等）

5. **查看可视化图表**
   在分析结果页面中，您可以查看以下可视化图表：
   - 规则处理流程图：展示规则的执行顺序和依赖关系
   - 攻击类型分布图：展示不同攻击类型的规则数量分布
   - 冲突分析图：展示规则之间的冲突关系

6. **下载分析报告**
   点击"下载报告"按钮，可以将分析结果下载为Markdown格式的详细报告。

### 3.3 智能检测功能

智能检测功能用于使用机器学习模型预测HTTP请求是否会被WAF拦截，操作步骤如下：

1. **打开智能检测页面**
   在前端界面左侧导航栏中，点击"智能检测"菜单项，进入智能检测页面。

2. **选择模型**
   从下拉菜单中选择要使用的机器学习模型。系统提供以下模型：
   - modsecurity_model：ModSecurity专用模型
   - generic_model：通用WAF模型

3. **输入HTTP请求**
   在请求输入框中输入要检测的HTTP请求，例如：
   ```
   GET /admin HTTP/1.1
   Host: www.example.com
   User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36
   ```
   您也可以点击"上传文件"按钮，上传包含HTTP请求的文本文件。

4. **执行检测**
   点击"开始检测"按钮，系统将使用选定的模型对HTTP请求进行预测。

5. **查看检测结果**
   检测完成后，页面将显示以下结果：
   - 预测结果：是否会被WAF拦截（blocked/allowed）
   - 预测置信度：模型对预测结果的置信程度
   - 特征分析：HTTP请求的关键特征和得分

### 3.4 历史记录功能

历史记录功能用于查看和管理您的分析历史，操作步骤如下：

1. **打开历史记录页面**
   在前端界面左侧导航栏中，点击"历史记录"菜单项，进入历史记录页面。

2. **查看历史记录**
   页面将显示您的所有分析历史，包括：
   - 分析类型（WAF扫描、规则分析、智能检测）
   - 分析时间
   - 分析对象（URL、文件名或请求摘要）
   - 分析结果摘要

3. **查看详细结果**
   点击历史记录项右侧的"查看详情"按钮，可以查看该次分析的详细结果。

4. **删除历史记录**
   点击历史记录项右侧的"删除"按钮，可以删除该次分析记录。

## 4. API使用指南

除了通过前端界面使用工具外，您还可以直接通过API调用各模块的功能。

### 4.1 API文档
您可以通过以下地址访问API文档：
- Swagger UI：http://localhost:8000/docs
- ReDoc：http://localhost:8000/redoc

### 4.2 常用API接口

#### 4.2.1 WAF扫描API

**接口地址**：`POST /api/waf/scan`

**请求体**：
```json
{
  "url": "https://www.example.com"
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "waf_type": "Cloudflare",
    "vendor": "Cloudflare Inc.",
    "method": "Header matching",
    "confidence": 0.95
  },
  "message": "WAF扫描成功"
}
```

#### 4.2.2 规则分析API

**接口地址**：`POST /api/waf/analyze-rules`

**请求体**：
- 类型：multipart/form-data
- 字段：files（规则文件，支持多个文件）

**响应**：
```json
{
  "success": true,
  "data": {
    "files": [
      {
        "filename": "rules.conf",
        "rule_count": 100,
        "processed_time": "2025-12-14 10:00:00",
        "rules": [...]
      }
    ],
    "total_rules": 100
  },
  "message": "规则分析成功"
}
```

#### 4.2.3 智能检测API

**接口地址**：`POST /api/waf/ai-detect`

**请求体**：
```json
{
  "url": "https://www.example.com",
  "request_content": "GET /admin HTTP/1.1\r\nHost: www.example.com\r\n\r\n"
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "prediction": "blocked",
    "confidence": 0.95,
    "features": [...]
  },
  "message": "智能检测成功"
}
```

#### 4.2.4 获取可视化图表API

**接口地址**：`GET /api/waf/visualizations/{visualization_type}?sessionId={sessionId}`

**参数说明**：
- visualization_type：可视化类型，支持以下值：
  - rule_processing_flow：规则处理流程图
  - attack_type_distribution：攻击类型分布图
  - conflict_analysis：冲突分析图
- sessionId：会话ID，用于确定文件存储的目录

**响应**：
- 返回HTML格式的可视化图表

#### 4.2.5 获取分析报告API

**接口地址**：`GET /api/waf/reports/{report_type}?sessionId={sessionId}`

**参数说明**：
- report_type：报告类型，目前支持 detailed_rules_report
- sessionId：会话ID，用于确定文件存储的目录

**响应**：
- 返回Markdown格式的分析报告

## 5. 高级用法

### 5.1 自定义WAF检测插件

您可以通过添加自定义插件来支持新的WAF类型，操作步骤如下：

1. **创建插件文件**
   在`Part1 waf_scanner/wafw00f/plugins`目录下创建一个新的Python文件，例如`mywaf.py`。

2. **编写插件代码**
   ```python
   #!/usr/bin/env python
   # -*- coding: utf-8 -*-"
   """
   MyWAF - WAF detection module for MyWAF
   """
   
   NAME = "MyWAF"
   VENDOR = "My Company"
   VERSION = "1.0"
   
   def is_waf(self):
       """
       Detect if the site is protected by MyWAF
       """
       # 检测逻辑
       if self.match_header("Server", "MyWAF"):
           return True
       
       if self.match_content("MyWAF Protection"):
           return True
           
       return False
   ```

3. **更新插件优先级**
   在`Part1 waf_scanner/wafw00f/wafprio.py`文件中添加新的WAF类型和优先级。

### 5.2 训练自定义机器学习模型

您可以使用自己的数据集训练自定义的机器学习模型，操作步骤如下：

1. **准备数据集**
   准备CSV格式的训练数据集，包含以下字段：
   - url：HTTP请求URL
   - method：请求方法
   - status_code：响应状态码
   - request_length：请求长度
   - waf_type：WAF类型
   - is_blocked：是否被拦截（1表示被拦截，0表示允许）

2. **训练模型**
   ```bash
   cd Part3 deeplearning
   python part3_waf_ml/main.py --mode train --model-type xgboost --waf-type mywaf --data-path my_data.csv --model-path mywaf_model.pkl
   ```

3. **使用自定义模型**
   将训练好的模型文件（.pkl）复制到`Part3 deeplearning/models`目录下，系统将自动识别并使用该模型。

### 5.3 批量分析规则文件

您可以通过API批量上传和分析多个规则文件：

```bash
curl -X POST "http://localhost:8000/api/waf/analyze-rules" \
  -H "Content-Type: multipart/form-data" \
  -F "files=@rules1.conf" \
  -F "files=@rules2.conf"
```

## 6. 常见问题解答

### 6.1 为什么扫描结果显示"未检测到WAF"？

可能的原因包括：
- 目标网站确实没有使用WAF
- 目标WAF采用了高级的绕过技术
- 目标WAF不在当前支持的WAF列表中
- 网络连接问题导致扫描失败

### 6.2 如何添加新的WAF类型支持？

在`Part1 waf_scanner/wafw00f/plugins`目录下创建新的插件文件，实现is_waf函数和相关检测逻辑，然后更新`wafprio.py`文件中的优先级配置。

### 6.3 为什么规则分析结果显示有冲突？

规则冲突通常是由于两个或多个规则的匹配条件重叠，或者规则执行顺序导致的。建议根据分析结果调整规则的优先级或修改规则的匹配条件。

### 6.4 如何提高智能检测的准确性？

可以通过以下方法提高智能检测的准确性：
- 使用更多样化的训练数据
- 调整模型参数
- 根据特定WAF类型训练专用模型
- 定期更新模型

### 6.5 如何导出所有分析结果？

您可以通过以下方式导出分析结果：
- 通过前端界面的"导出报告"按钮导出单次分析结果
- 通过API调用获取所有分析结果
- 直接访问数据库文件（`Part2 analysis/part2_rule_analysis/2.0/backend/analysis_results/rules.db`）

## 7. 故障排除

### 7.1 后端服务无法启动

- 检查Python版本是否符合要求（3.7+）
- 检查依赖是否正确安装（可以尝试重新安装依赖）
- 检查端口是否被占用（可以修改配置文件中的端口号）
- 查看控制台输出的错误信息，根据错误信息进行修复

### 7.2 前端服务无法启动

- 检查Node.js版本是否符合要求（16.0+）
- 检查依赖是否正确安装（可以尝试重新安装依赖）
- 查看控制台输出的错误信息，根据错误信息进行修复

### 7.3 前端无法连接到后端服务

- 检查后端服务是否正常运行
- 检查前端配置文件中的API地址是否正确
- 检查网络连接是否正常
- 检查防火墙是否阻止了连接

### 7.4 扫描或分析过程中出现错误

- 检查输入参数是否正确
- 检查目标网站是否可访问
- 检查规则文件格式是否正确
- 查看控制台输出的错误信息，根据错误信息进行修复

## 8. 性能优化建议

### 8.1 提高扫描速度

- 减少并发扫描数量
- 优化WAF插件的检测逻辑
- 使用更快的网络连接

### 8.2 提高规则分析性能

- 对大文件进行分块处理
- 优化规则解析算法
- 使用更高效的数据结构存储规则信息

### 8.3 提高智能检测性能

- 使用更轻量级的模型
- 优化特征提取算法
- 使用批处理方式进行预测

## 9. 安全最佳实践

1. **合法使用**
   - 使用该工具扫描目标网站时，请确保遵守相关法律法规
   - 获得目标网站所有者的授权后再进行扫描和分析
   - 不要将该工具用于非法用途

2. **数据保护**
   - 规则文件可能包含敏感信息，分析过程中请注意保护
   - 建议在安全环境中运行分析程序
   - 分析结果应妥善保存，避免泄露敏感数据

3. **系统安全**
   - 定期更新系统和依赖库，修复安全漏洞
   - 使用强密码保护数据库和管理界面
   - 配置适当的访问控制，限制API的访问范围


## 10. 版本更新日志

### 版本 1.0.0（2025-12-14）
- 初始版本发布
- 包含WAF指纹识别、规则分析和智能检测功能
- 提供Web界面和API接口
- 支持多种WAF类型和规则格式

---

**文档更新日期**：2025年12月14日
**文档版本**：1.0
**作者**：项目开发团队